{
  "name": "Razorpay - Payment Webhook Handler",
  "description": "Handles Razorpay subscription events: activated, paused, cancelled. Updates DB and sends notifications.",
  "nodes": [
    {
      "name": "Webhook - Razorpay",
      "type": "n8n-nodes-base.webhook",
      "position": [100, 200],
      "parameters": {
        "path": "webhook/razorpay",
        "httpMethod": "POST",
        "responseMode": "onReceived"
      }
    },
    {
      "name": "Verify Signature",
      "type": "n8n-nodes-base.function",
      "position": [300, 200],
      "parameters": {
        "functionCode": "const crypto = require('crypto');\nconst signature = $json.headers['x-razorpay-signature'];\nconst body = $json.body;\nconst secret = process.env.RAZORPAY_KEY_SECRET;\n\nconst hash = crypto\n  .createHmac('sha256', secret)\n  .update(body)\n  .digest('hex');\n\nreturn { valid: hash === signature };"
      }
    },
    {
      "name": "Check Event Type",
      "type": "n8n-nodes-base.switch",
      "position": [500, 200],
      "parameters": {
        "cases": [
          {
            "condition": "eventType === 'subscription.activated'",
            "output": 0
          },
          {
            "condition": "eventType === 'subscription.paused'",
            "output": 1
          },
          {
            "condition": "eventType === 'subscription.cancelled'",
            "output": 2
          }
        ]
      }
    },
    {
      "name": "Update Subscription - Activated",
      "type": "n8n-nodes-base.postgres",
      "position": [700, 100],
      "parameters": {
        "operation": "update",
        "table": "subscriptions",
        "where": "razorpay_subscription_id = '={{ $json.payload.subscription.entity.id }}'",
        "set": "status = 'active', updated_at = NOW()"
      }
    },
    {
      "name": "Update Subscription - Paused",
      "type": "n8n-nodes-base.postgres",
      "position": [700, 200],
      "parameters": {
        "operation": "update",
        "table": "subscriptions",
        "where": "razorpay_subscription_id = '={{ $json.payload.subscription.entity.id }}'",
        "set": "status = 'paused', updated_at = NOW()"
      }
    },
    {
      "name": "Update Subscription - Cancelled",
      "type": "n8n-nodes-base.postgres",
      "position": [700, 300],
      "parameters": {
        "operation": "update",
        "table": "subscriptions",
        "where": "razorpay_subscription_id = '={{ $json.payload.subscription.entity.id }}'",
        "set": "status = 'cancelled', updated_at = NOW()"
      }
    },
    {
      "name": "Send Confirmation Email",
      "type": "n8n-nodes-base.resend",
      "position": [900, 100],
      "parameters": {
        "from": "noreply@at-solvexx.com",
        "to": "={{ $json.user_email }}",
        "subject": "Subscription Activated - Welcome to Pro!",
        "htmlBody": "<h1>Welcome to Pro!</h1><p>Your subscription has been activated. Your portfolio is now live with premium features.</p>"
      }
    },
    {
      "name": "Send Pause Notification",
      "type": "n8n-nodes-base.resend",
      "position": [900, 200],
      "parameters": {
        "from": "noreply@at-solvexx.com",
        "to": "={{ $json.user_email }}",
        "subject": "Subscription Paused",
        "htmlBody": "<h1>Subscription Paused</h1><p>Your subscription has been paused. You can resume it anytime from your dashboard.</p>"
      }
    },
    {
      "name": "Send Cancellation Email",
      "type": "n8n-nodes-base.resend",
      "position": [900, 300],
      "parameters": {
        "from": "noreply@at-solvexx.com",
        "to": "={{ $json.user_email }}",
        "subject": "Subscription Cancelled",
        "htmlBody": "<h1>Subscription Cancelled</h1><p>Your subscription has been cancelled. We hope to see you again soon!</p>"
      }
    }
  ],
  "connections": {
    "Webhook - Razorpay": {
      "main": [
        [
          {
            "node": "Verify Signature",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Signature": {
      "main": [
        [
          {
            "node": "Check Event Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Event Type": {
      "main": [
        [
          {
            "node": "Update Subscription - Activated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Subscription - Paused",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Subscription - Cancelled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Subscription - Activated": {
      "main": [
        [
          {
            "node": "Send Confirmation Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Subscription - Paused": {
      "main": [
        [
          {
            "node": "Send Pause Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Subscription - Cancelled": {
      "main": [
        [
          {
            "node": "Send Cancellation Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
